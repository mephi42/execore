#!/bin/bash
set -e -u -x -o pipefail

source_dir=$(cd "$(dirname "$0")"/.. && pwd)

execore=$1
shift
phoenix=$1
shift
execore_dir=$(cd "$(dirname "$execore")" && pwd)
export PATH=$execore_dir:$PATH

workdir=$(mktemp -d)
trap 'rm -rf "$workdir"' EXIT
cd "$workdir"

gdb "$phoenix" \
    --batch \
    --eval-command="set python print-stack full" \
    --eval-command="source $source_dir/scripts/execore-record.py" \
    --eval-command="starti" \
    --eval-command="execore-record-replay --memory 1000" \
    --eval-command=quit 2>&1 | tee log
grep "Saved corefile" log
grep "Traces match" log
