#!/bin/bash
set -e -u -x -o pipefail

source_dir=$(cd "$(dirname "$0")"/.. && pwd)

execore=$1
shift
execore_dir=$(cd "$(dirname "$execore")" && pwd)
export PATH=$execore_dir:$PATH

workdir=$(mktemp -d)
trap 'rm -rf "$workdir"' EXIT
cd "$workdir"

gdb /bin/bash \
  --batch \
  --eval-command="source $source_dir/scripts/execore-record.py" \
  --eval-command="starti" \
  --eval-command="execore-record 1000" \
  --eval-command=quit
mkdir extracted
tar -C extracted -xf execore.tar.gz
[ "$(find extracted -name "trace.*" -print0 | xargs -0 cat | grep -c ^\\[)" = 1000 ]
"$source_dir"/scripts/execore-replay execore.tar.gz
cat execore.diff
[ ! -s execore.diff ]

gdb /bin/bash \
  --batch \
  --eval-command="source $source_dir/scripts/execore-record.py" \
  --eval-command="starti" \
  --eval-command="execore-record-replay 1000" \
  --eval-command=quit 2>&1 | tee log
grep "Saved corefile" log
grep "Traces match" log
